#!/bin/zsh
SCRIPT_PATH="$( cd "$(dirname "$0")" ; pwd -P )"

# Source external scripts.
source $SCRIPT_PATH/scripts/colors

# Update a `HEAD` brew package if there are remote changes available.
function update_brew_pkg_head() {
  pkg_name=$1
  echo -e "\n${blue}Updating ${clear}$pkg_name${blue} to latest HEAD...${clear}"
  repo_path=/Library/Caches/Homebrew/$pkg_name--git/
  local_sha=`cd $repo_path && git rev-parse @`
  remote_sha=`cd $repo_path && git fetch && git rev-parse @{u}`
  if [[ $local_sha == $remote_sha ]]; then
    echo -e "${green}Already up to date.${clear}"
  else
    brew reinstall --HEAD $pkg_name
    echo -e "\n${green}Done.${clear}"
  fi
}

# Homebrew
echo -e "\n${blue}Updating Homebrew packages...${clear}"
brew update
brew upgrade --all
brew cleanup
echo -e "${green}Done.${clear}"

# HEAD Homebrew packages
update_brew_pkg_head neovim
#update_brew_pkg_head tmux

# Git submodules
echo -e "\n${blue}Updating Git submodules...${clear}"
git submodule update --remote --rebase
echo -e "${green}Done.${clear}"

# gem
echo -e "\n${blue}Updating Ruby gems...${clear}"
gem update
echo -e "${green}Done.${clear}"

# pip
echo -e "\n${blue}Updating certain PIP packages...${clear}"
pip install -U pip neovim awscli tmuxp docker-compose
echo -e "${green}Done.${clear}"

# Tmux plugins
echo -e "\n${blue}Updating Tmux plugins...${clear}"
$SCRIPT_PATH/libs/tpm/bin/clean_plugins
$SCRIPT_PATH/libs/tpm/bin/update_plugins all
echo -e "${green}Done.${clear}"

# zplug
echo -e "\n${blue}Updating ZSH plugins...${clear}"
zplug update --self
zplug update
zplug clean
zplug load --verbose
echo -e "${green}Done.${clear}"

echo -e "\n${green}All done.${clear}"

echo ""
